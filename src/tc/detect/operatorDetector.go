package detect

import (
	"net"
	"tc/openrtbex"
)

type OperatorDetector struct {
	mts     []*net.IPNet
	beeline []*net.IPNet
	megafon []*net.IPNet
}

func NewOperatorDetector() *OperatorDetector {
	op := &OperatorDetector{}
	op.mts = op.getMtsIpNet()
	op.megafon = op.getMegafonIpNet()
	op.beeline = op.getBeelineIpNet()
	return op
}

func (s *OperatorDetector) Detect(ip string) openrtbex.Operator {
	nIp := net.ParseIP(ip)

	if s.isMatch(s.beeline, nIp) {
		return openrtbex.OperatorBeeline
	}

	if s.isMatch(s.megafon, nIp) {
		return openrtbex.OperatorMegafon
	}

	if s.isMatch(s.mts, nIp) {
		return openrtbex.OperatorMTS
	}

	//todo detect tele2 by geoId (db org)
	return openrtbex.OperatorUnknown
}

func (s *OperatorDetector) isMatch(ipNetList []*net.IPNet, ip net.IP) bool {
	for _, n := range ipNetList {
		if n.Contains(ip) {
			return true
		}
	}

	return false
}

func (s *OperatorDetector) getBeelineIpNet() []*net.IPNet {
	return s.ipListToIpNetList([]string{
		"217.118.95.96/27",
		"217.118.95.64/27",
		"85.115.248.128/25",
		"85.115.248.0/25",
		"89.188.224.136/29",
		"85.115.248.0/24",
		"85.115.248.254/32",
		"85.115.248.252/31",
		"85.115.248.248/30",
		"85.115.248.240/29",
		"85.115.248.224/28",
		"85.115.248.192/27",
		"85.115.248.160/27",
		"85.115.248.144/28",
		"85.115.248.136/29",
		"85.115.248.132/30",
		"85.115.248.130/31",
		"85.115.248.129/32",
		"85.115.243.62/32",
		"85.115.243.60/31",
		"85.115.243.56/30",
		"85.115.243.48/29",
		"85.115.243.40/29",
		"85.115.243.36/30",
		"85.115.243.34/31",
		"85.115.243.33/32",
		"85.115.243.32/27",
		"85.115.235.254/32",
		"85.115.235.252/31",
		"85.115.235.248/30",
		"85.115.235.240/29",
		"85.115.235.224/28",
		"85.115.235.192/27",
		"85.115.235.128/26",
		"85.115.235.0/25",
		"85.115.234.8/29",
		"85.115.234.64/26",
		"85.115.234.4/30",
		"85.115.234.32/27",
		"85.115.234.2/31",
		"85.115.234.16/28",
		"85.115.234.128/25",
		"85.115.234.1/32",
		"85.115.224.9/32",
		"85.115.224.254/32",
		"85.115.224.252/31",
		"85.115.224.248/30",
		"85.115.224.240/29",
		"85.115.224.232/29",
		"85.115.224.228/30",
		"85.115.224.226/31",
		"85.115.224.225/32",
		"85.115.224.222/32",
		"85.115.224.220/31",
		"85.115.224.216/30",
		"85.115.224.208/29",
		"85.115.224.200/29",
		"85.115.224.196/30",
		"85.115.224.194/31",
		"85.115.224.193/32",
		"85.115.224.128/27",
		"85.115.224.10/32",
		"83.220.239.254/32",
		"83.220.239.252/31",
		"83.220.239.248/30",
		"83.220.239.240/29",
		"83.220.239.224/28",
		"83.220.239.192/27",
		"83.220.239.128/26",
		"83.220.239.0/25",
		"83.220.238.0/24",
		"83.220.237.0/24",
		"83.220.236.8/29",
		"83.220.236.64/26",
		"83.220.236.4/30",
		"83.220.236.32/27",
		"83.220.236.2/31",
		"83.220.236.16/28",
		"83.220.236.128/25",
		"83.220.236.1/32",
		"83.220.227.0/24",
		"62.33.151.0/24",
		"46.16.96.0/21",
		"31.13.144.8/29",
		"31.13.144.62/32",
		"31.13.144.60/31",
		"31.13.144.56/30",
		"31.13.144.48/29",
		"31.13.144.4/30",
		"31.13.144.32/28",
		"31.13.144.2/31",
		"31.13.144.16/28",
		"217.148.194.142/32",
		"217.148.194.140/31",
		"217.148.194.136/30",
		"217.148.194.132/30",
		"217.148.194.130/31",
		"217.148.194.129/32",
		"217.119.95.192/32",
		"217.119.95.128/26",
		"217.119.95.0/25",
		"217.119.94.0/24",
		"217.119.92.0/23",
		"217.119.88.0/22",
		"217.119.80.0/21",
		"217.119.64.0/20",
		"217.119.0.0/18",
		"217.118.96.0/19",
		"217.118.95.80/28",
		"217.118.95.72/29",
		"217.118.95.68/30",
		"217.118.95.66/31",
		"217.118.95.65/32",
		"217.118.95.0/25",
		"217.118.95.128/25",
		"217.118.93.126/32",
		"217.118.93.124/31",
		"217.118.93.120/30",
		"217.118.93.112/29",
		"217.118.93.104/29",
		"217.118.93.0/24",
		"217.118.92.8/29",
		"217.118.92.64/26",
		"217.118.92.4/30",
		"217.118.92.32/27",
		"217.118.92.254/32",
		"217.118.92.252/31",
		"217.118.92.248/30",
		"217.118.92.240/29",
		"217.118.92.224/28",
		"217.118.92.2/31",
		"217.118.92.192/27",
		"217.118.92.16/28",
		"217.118.92.128/26",
		"217.118.92.1/32",
		"217.118.92.0/24",
		"217.118.91.96/28",
		"217.118.91.80/28",
		"217.118.91.72/29",
		"217.118.91.68/30",
		"217.118.91.66/31",
		"217.118.91.65/32",
		"217.118.91.64/26",
		"217.118.91.126/32",
		"217.118.91.124/31",
		"217.118.91.120/30",
		"217.118.91.112/29",
		"217.118.90.8/29",
		"217.118.90.64/26",
		"217.118.90.4/30",
		"217.118.90.32/27",
		"217.118.90.254/32",
		"217.118.90.252/31",
		"217.118.90.248/30",
		"217.118.90.240/29",
		"217.118.90.224/28",
		"217.118.90.2/31",
		"217.118.90.192/27",
		"217.118.90.16/28",
		"217.118.90.128/26",
		"217.118.90.1/32",
		"217.118.90.0/24",
		"217.118.89.0/24",
		"217.118.85.64/28",
		"217.118.85.0/24",
		"217.118.83.254/32",
		"217.118.83.252/31",
		"217.118.83.248/30",
		"217.118.83.240/29",
		"217.118.83.224/28",
		"217.118.83.192/27",
		"217.118.83.160/27",
		"217.118.83.144/28",
		"217.118.83.136/29",
		"217.118.83.132/30",
		"217.118.83.130/31",
		"217.118.83.128/25",
		"217.118.83.129/32",
		"217.118.83.0/24",
		"217.118.82.64/26",
		"217.118.82.32/28",
		"217.118.82.192/26",
		"217.118.82.16/28",
		"217.118.82.128/26",
		"217.118.81.62/32",
		"217.118.81.60/31",
		"217.118.81.56/30",
		"217.118.81.48/29",
		"217.118.81.40/29",
		"217.118.81.36/30",
		"217.118.81.34/31",
		"217.118.81.33/32",
		"217.118.81.254/32",
		"217.118.81.252/31",
		"217.118.81.248/30",
		"217.118.81.240/29",
		"217.118.81.224/28",
		"217.118.81.208/28",
		"217.118.81.200/29",
		"217.118.81.196/30",
		"217.118.81.194/31",
		"217.118.81.193/32",
		"217.118.81.192/27",
		"217.118.81.128/26",
		"217.118.81.0/25",
		"217.118.81.0/24",
		"217.118.80.0/24",
		"217.118.79.46/32",
		"217.118.79.44/31",
		"217.118.79.40/30",
		"217.118.79.36/30",
		"217.118.79.34/31",
		"217.118.79.33/32",
		"217.118.79.32/28",
		"217.118.79.0/24",
		"217.118.78.8/29",
		"217.118.78.64/26",
		"217.118.78.4/30",
		"217.118.78.32/27",
		"217.118.78.254/32",
		"217.118.78.252/31",
		"217.118.78.248/30",
		"217.118.78.240/29",
		"217.118.78.224/28",
		"217.118.78.2/31",
		"217.118.78.192/27",
		"217.118.78.16/28",
		"217.118.78.128/26",
		"217.118.78.128/25",
		"217.118.78.1/32",
		"217.118.78.0/24",
		"217.118.66.96/30",
		"217.118.66.8/29",
		"217.118.66.64/27",
		"217.118.66.64/26",
		"217.118.66.4/30",
		"217.118.66.32/27",
		"217.118.66.254/32",
		"217.118.66.252/31",
		"217.118.66.248/30",
		"217.118.66.240/29",
		"217.118.66.224/28",
		"217.118.66.2/31",
		"217.118.66.192/27",
		"217.118.66.160/27",
		"217.118.66.16/28",
		"217.118.66.152/29",
		"217.118.66.148/30",
		"217.118.66.146/31",
		"217.118.66.145/32",
		"217.118.66.142/32",
		"217.118.66.140/31",
		"217.118.66.136/30",
		"217.118.66.128/29",
		"217.118.66.100/31",
		"217.118.66.1/32",
		"217.118.66.0/24",
		"217.118.64.46/32",
		"217.118.64.44/31",
		"217.118.64.40/30",
		"217.118.64.36/30",
		"217.118.64.34/31",
		"217.118.64.33/32",
		"217.118.64.32/28",
		"217.118.64.32/27",
		"217.118.128.0/17",
		"213.252.195.0/24",
	})
}

func (s *OperatorDetector) getMegafonIpNet() []*net.IPNet {
	return s.ipListToIpNetList([]string{
		"193.201.231.2/32",
		"46.229.132.0/24",
		"46.229.133.0/24",
		"46.229.134.0/24",
		"46.229.140.0/24",
		"46.229.141.0/24",
		"78.25.120.0/22",
		"78.25.88.0/22",
		"78.25.92.0/24",
		"78.25.93.0/24",
		"83.149.1.192/30",
		"83.149.1.196/30",
		"83.149.1.200/29",
		"83.149.2.0/23",
		"83.149.21.0/24",
		"83.149.24.64/26",
		"83.149.25.0/24",
		"83.149.34.128/25",
		"83.149.35.0/24",
		"83.149.36.0/25",
		"83.149.36.128/25",
		"83.149.38.0/24",
		"83.149.43.128/25",
		"83.149.44.0/23",
		"83.149.46.0/23",
		"83.149.48.0/25",
		"83.149.52.0/22",
		"85.26.155.0/24",
		"85.26.164.0/23",
		"85.26.183.0/24",
		"85.26.184.0/24",
		"85.26.186.0/24",
		"85.26.192.0/24",
		"85.26.193.0/24",
		"85.26.194.0/24",
		"85.26.195.0/24",
		"85.26.224.0/26",
		"85.26.227.0/24",
		"85.26.228.0/24",
		"85.26.229.0/24",
		"85.26.230.0/24",
		"85.26.231.0/25",
		"85.26.232.0/23",
		"85.26.234.0/23",
		"85.26.241.0/24",
		"83.149.8.0/23",
		"109.195.94.0/24",
		"116.58.209.0/24",
		"121.125.69.0/24",
		"141.0.10.0/24",
		"141.0.11.0/24",
		"141.0.12.0/24",
		"141.0.13.0/24",
		"141.0.14.0/24",
		"141.0.15.0/24",
		"141.0.8.0/24",
		"141.0.9.0/24",
		"193.201.228.0/24",
		"193.201.229.0/24",
		"193.201.230.0/24",
		"193.201.231.0/24",
		"195.189.142.0/24",
		"195.189.143.0/24",
		"203.81.19.0/24",
		"209.170.68.0/24",
		"217.212.226.0/24",
		"217.212.230.0/24",
		"217.212.231.0/24",
		"37.28.168.0/24",
		"37.28.169.0/24",
		"37.28.170.0/24",
		"37.28.171.0/24",
		"37.28.172.0/24",
		"37.28.173.0/24",
		"37.28.174.0/24",
		"37.28.175.0/24",
		"37.29.86.0/24",
		"37.29.87.0/24",
		"37.29.88.0/24",
		"37.29.89.0/24",
		"37.29.90.0/24",
		"37.29.91.0/24",
		"46.229.128.0/24",
		"46.229.129.0/24",
		"46.229.130.0/24",
		"46.229.131.0/24",
		"46.229.135.0/24",
		"46.229.136.0/24",
		"46.229.137.0/24",
		"46.229.138.0/24",
		"46.229.139.0/24",
		"46.229.142.0/24",
		"46.229.143.0/24",
		"58.120.225.0/24",
		"59.151.106.0/24",
		"59.151.120.0/24",
		"59.151.98.0/24",
		"64.255.164.0/24",
		"64.255.180.0/24",
		"78.25.104.0/24",
		"78.25.105.0/24",
		"78.25.106.0/24",
		"78.25.107.0/24",
		"78.25.108.0/24",
		"78.25.109.0/24",
		"78.25.110.0/24",
		"78.25.111.0/24",
		"78.25.116.0/24",
		"78.25.117.0/24",
		"78.25.118.0/24",
		"78.25.120.0/24",
		"78.25.121.0/24",
		"78.25.122.0/24",
		"78.25.123.0/24",
		"78.25.124.0/24",
		"78.25.125.0/24",
		"78.25.126.0/24",
		"78.25.127.0/24",
		"78.25.74.0/24",
		"78.25.75.0/24",
		"78.25.80.0/24",
		"78.25.81.0/24",
		"78.25.82.0/24",
		"78.25.83.0/24",
		"78.25.84.0/24",
		"78.25.85.0/24",
		"78.25.86.0/24",
		"78.25.87.0/24",
		"78.25.88.0/24",
		"78.25.89.0/24",
		"78.25.90.0/24",
		"78.25.91.0/24",
		"78.25.94.0/24",
		"78.25.95.0/24",
		"80.239.242.0/24",
		"80.239.243.0/24",
		"80.84.1.0/24",
		"81.3.148.0/24",
		"82.145.208.0/24",
		"82.145.209.0/24",
		"82.145.210.0/24",
		"82.145.211.0/24",
		"82.145.212.0/24",
		"82.145.213.0/24",
		"82.145.214.0/24",
		"82.145.215.0/24",
		"82.145.216.0/24",
		"82.145.217.0/24",
		"82.145.218.0/24",
		"82.145.219.0/24",
		"82.145.220.0/24",
		"82.145.221.0/24",
		"82.145.222.0/24",
		"82.145.223.0/24",
		"83.149.0.0/24",
		"83.149.1.0/24",
		"83.149.19.0/24",
		"83.149.2.0/24",
		"83.149.20.0/24",
		"83.149.22.0/24",
		"83.149.23.0/24",
		"83.149.24.0/24",
		"83.149.26.0/24",
		"83.149.27.0/24",
		"83.149.28.0/24",
		"83.149.3.0/24",
		"83.149.32.0/24",
		"83.149.33.0/24",
		"83.149.34.0/24",
		"83.149.36.0/24",
		"83.149.37.0/24",
		"83.149.39.0/24",
		"83.149.4.0/24",
		"83.149.40.0/24",
		"83.149.41.0/24",
		"83.149.42.0/24",
		"83.149.43.0/24",
		"83.149.44.0/24",
		"83.149.45.0/24",
		"83.149.46.0/24",
		"83.149.47.0/24",
		"83.149.48.0/24",
		"83.149.49.0/24",
		"83.149.5.0/24",
		"83.149.50.0/24",
		"83.149.51.0/24",
		"83.149.52.0/24",
		"83.149.53.0/24",
		"83.149.54.0/24",
		"83.149.55.0/24",
		"83.149.6.0/24",
		"83.149.7.0/24",
		"83.149.8.0/24",
		"83.149.9.0/24",
		"85.26.128.0/24",
		"85.26.129.0/24",
		"85.26.130.0/24",
		"85.26.131.0/24",
		"85.26.136.0/24",
		"85.26.137.0/24",
		"85.26.138.0/24",
		"85.26.139.0/24",
		"85.26.140.0/24",
		"85.26.141.0/24",
		"85.26.142.0/24",
		"85.26.143.0/24",
		"85.26.164.0/24",
		"85.26.165.0/24",
		"85.26.166.0/24",
		"85.26.167.0/24",
		"85.26.176.0/24",
		"85.26.177.0/24",
		"85.26.178.0/24",
		"85.26.179.0/24",
		"85.26.180.0/24",
		"85.26.181.0/24",
		"85.26.182.0/24",
		"85.26.185.0/24",
		"85.26.187.0/24",
		"85.26.191.0/24",
		"85.26.196.0/24",
		"85.26.197.0/24",
		"85.26.198.0/24",
		"85.26.204.0/24",
		"85.26.208.0/24",
		"85.26.209.0/24",
		"85.26.210.0/24",
		"85.26.211.0/24",
		"85.26.212.0/24",
		"85.26.213.0/24",
		"85.26.214.0/24",
		"85.26.215.0/24",
		"85.26.216.0/24",
		"85.26.217.0/24",
		"85.26.218.0/24",
		"85.26.219.0/24",
		"85.26.220.0/24",
		"85.26.221.0/24",
		"85.26.222.0/24",
		"85.26.223.0/24",
		"85.26.224.0/24",
		"85.26.225.0/24",
		"85.26.226.0/24",
		"85.26.231.0/24",
		"85.26.232.0/24",
		"85.26.233.0/24",
		"85.26.234.0/24",
		"85.26.235.0/24",
		"85.26.240.0/24",
		"85.26.242.0/24",
		"85.26.243.0/24",
		"85.26.244.0/24",
		"85.26.245.0/24",
		"85.26.248.0/24",
		"85.26.249.0/24",
		"85.26.250.0/24",
		"85.26.251.0/24",
		"91.203.96.0/24",
		"91.203.97.0/24",
		"91.203.98.0/24",
		"91.203.99.0/24",
		"185.3.32.0/22",
		"185.3.32.0/23",
		"185.3.34.0/23",
		"37.28.185.0/24",
		"37.28.187.0/24",
		"46.232.202.0/23",
		"83.169.252.0/22",
		"85.26.189.0/24",
		"37.29.48.0/21",
		"37.29.96.0/20",
		"46.29.192.0/21",
	})
}

func (s *OperatorDetector) getMtsIpNet() []*net.IPNet {
	return s.ipListToIpNetList([]string{
		"194.54.148.8/32",
		"195.74.84.32/32",
		"213.87.112.0/23",
		"213.87.114.0/23",
		"213.87.118.0/23",
		"213.87.120.0/22",
		"213.87.124.0/24",
		"213.87.128.0/20",
		"213.87.240.0/22",
		"213.87.54.0/24",
		"213.87.55.0/24",
		"213.87.6.8/32",
		"213.87.65.5/32",
		"213.87.65.6/32",
		"213.87.72.73/32",
		"213.87.74.0/24",
		"213.87.76.0/24",
		"213.87.77.0/24",
		"213.87.8.0/21",
		"213.87.80.0/20",
		"213.87.94.0/24",
		"213.87.95.0/24",
		"217.66.145.15/32",
		"217.66.145.16/32",
		"217.66.146.0/26",
		"217.66.147.0/24",
		"217.66.148.0/24",
		"217.66.149.0/24",
		"217.66.150.0/24",
		"217.66.151.0/24",
		"217.66.152.0/24",
		"217.66.155.0/24",
		"217.66.156.0/24",
		"217.66.157.0/24",
		"217.66.158.0/24",
		"217.66.159.0/24",
		"217.74.244.128/25",
		"217.74.244.13/32",
		"217.74.245.0/24",
		"217.74.246.0/23",
		"217.74.248.0/22",
		"217.74.252.0/23",
		"217.8.226.0/23",
		"217.8.228.0/23",
		"217.8.230.0/23",
		"217.8.232.0/23",
		"217.8.234.0/24",
		"217.8.239.0/24",
		"80.83.224.0/25",
		"80.83.228.0/22",
		"80.83.232.0/23",
		"80.83.237.0/25",
		"80.83.238.0/25",
		"80.83.238.246/32",
		"80.83.239.0/25",
		"84.17.224.252/32",
		"84.17.254.0/23",
		"95.153.160.0/19",
		"95.153.192.0/20",
		"95.153.208.0/21",
		"95.153.244.0/22",
		"95.153.248.0/21",
	})
}

func (s *OperatorDetector) ipListToIpNetList(ipList []string) []*net.IPNet {
	list := make([]*net.IPNet, 0)

	for _, ip := range ipList {
		_, n, err := net.ParseCIDR(ip)

		if err != nil {
			continue
		}

		list = append(list, n)
	}

	return list
}
